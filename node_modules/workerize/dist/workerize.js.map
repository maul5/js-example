{"version":3,"file":"workerize.js","sources":["../src/index.js"],"sourcesContent":["\n/** TODO:\n *\t- pooling (+ load balancing by tracking # of open calls)\n *  - queueing (worth it? sortof free via postMessage already)\n *\n *\t@example\n *\tlet worker = workerize(`\n *\t\texport function add(a, b) {\n *\t\t\t// block for a quarter of a second to demonstrate asynchronicity\n *\t\t\tlet start = Date.now();\n *\t\t\twhile (Date.now()-start < 250);\n *\t\t\treturn a + b;\n *\t\t}\n *\t`);\n *\t(async () => {\n *\t\tconsole.log('3 + 9 = ', await worker.add(3, 9));\n *\t\tconsole.log('1 + 2 = ', await worker.add(1, 2));\n *\t})();\n */\nexport default function workerize(code, options) {\n\tlet exports = {};\n\tlet exportsObjName = `__xpo${Math.random().toString().substring(2)}__`;\n\tif (typeof code==='function') code = `(${Function.prototype.toString.call(code)})(${exportsObjName})`;\n\tcode = toCjs(code, exportsObjName, exports) + `\\n(${Function.prototype.toString.call(setup)})(self,${exportsObjName},{})`;\n\tlet url = URL.createObjectURL(new Blob([code])),\n\t\tworker = new Worker(url, options),\n\t\tterm = worker.terminate,\n\t\tcallbacks = {},\n\t\tcounter = 0,\n\t\ti;\n\tworker.kill = signal => {\n\t\tworker.postMessage({ type: 'KILL', signal });\n\t\tsetTimeout(worker.terminate);\n\t};\n\tworker.terminate = () => {\n\t\tURL.revokeObjectURL(url);\n\t\tterm.call(this);\n\t};\n\tworker.call = (method, params) => new Promise( (resolve, reject) => {\n\t\tlet id = `rpc${++counter}`;\n\t\tcallbacks[id] = [resolve, reject];\n\t\tworker.postMessage({ type: 'RPC', id, method, params });\n\t});\n\tworker.rpcMethods = {};\n\tsetup(worker, worker.rpcMethods, callbacks);\n\tworker.expose = methodName => {\n\t\tworker[i] = function() {\n\t\t\treturn worker.call(methodName, [].slice.call(arguments));\n\t\t};\n\t};\n\tfor (i in exports) if (!(i in worker)) worker.expose(i);\n\treturn worker;\n}\n\nfunction setup(ctx, rpcMethods, callbacks) {\n\tctx.addEventListener('message', ({ data }) => {\n\t\tlet id = data.id;\n\t\tif (data.type!=='RPC' || id==null) return;\n\t\tif (data.method) {\n\t\t\tlet method = rpcMethods[data.method];\n\t\t\tif (method==null) {\n\t\t\t\tctx.postMessage({ type: 'RPC', id, error: 'NO_SUCH_METHOD' });\n\t\t\t}\n\t\t\telse {\n\t\t\t\tPromise.resolve()\n\t\t\t\t\t.then( () => method.apply(null, data.params) )\n\t\t\t\t\t.then( result => { ctx.postMessage({ type: 'RPC', id, result }); })\n\t\t\t\t\t.catch( err => { ctx.postMessage({ type: 'RPC', id, error: ''+err }); });\n\t\t\t}\n\t\t}\n\t\telse {\n\t\t\tlet callback = callbacks[id];\n\t\t\tif (callback==null) throw Error(`Unknown callback ${id}`);\n\t\t\tdelete callbacks[id];\n\t\t\tif (data.error) callback[1](Error(data.error));\n\t\t\telse callback[0](data.result);\n\t\t}\n\t});\n}\n\nfunction toCjs(code, exportsObjName, exports) {\n\tcode = code.replace(/^(\\s*)export\\s+default\\s+/m, (s, before) => {\n\t\texports.default = true;\n\t\treturn `${before}${exportsObjName}.default=`;\n\t});\n\tcode = code.replace(/^(\\s*)export\\s+((?:async\\s*)?function(?:\\s*\\*)?|const|let|var)(\\s+)([a-zA-Z$_][a-zA-Z0-9$_]*)/mg, (s, before, type, ws, name) => {\n\t\texports[name] = true;\n\t\treturn `${before}${exportsObjName}.${name}=${type}${ws}${name}`;\n\t});\n\treturn `var ${exportsObjName}={};\\n${code}\\n${exportsObjName};`;\n}\n"],"names":["setup","ctx","rpcMethods","callbacks","addEventListener","ref","data","id","type","method","let","postMessage","error","Promise","resolve","then","apply","params","result","catch","err","callback","Error","code","options","exports","exportsObjName","Math","random","toString","substring","Function","prototype","call","replace","s","before","default","ws","name","toCjs","i","url","URL","createObjectURL","Blob","worker","Worker","term","terminate","counter","kill","signal","setTimeout","revokeObjectURL","this","reject","expose","methodName","slice","arguments"],"mappings":"AAsDA,SAASA,EAAMC,EAAKC,EAAYC,GAC/BF,EAAIG,iBAAiB,mBAAYC,OAAEC,SAC9BC,EAAKD,EAAKC,GACd,GAAgB,QAAZD,EAAKE,MAAoB,MAAJD,EACzB,GAAID,EAAKG,OAAQ,CAChBC,IAAID,EAASP,EAAWI,EAAKG,QACjB,MAARA,EACHR,EAAIU,aAAcH,KAAM,SAAOD,EAAIK,MAAO,mBAG1CC,QAAQC,UACNC,uBAAYN,EAAOO,MAAM,KAAMV,EAAKW,UACpCF,cAAMG,GAAYjB,EAAIU,aAAcH,KAAM,SAAOD,SAAIW,MACrDC,eAAOC,GAASnB,EAAIU,aAAcH,KAAM,SAAOD,EAAIK,MAAO,GAAGQ,UAG5D,CACJV,IAAIW,EAAWlB,EAAUI,GACzB,GAAc,MAAVc,EAAgB,MAAMC,0BAA0Bf,UAC7CJ,EAAUI,GACbD,EAAKM,MAAOS,EAAS,GAAGC,MAAMhB,EAAKM,QAClCS,EAAS,GAAGf,EAAKY,0BAxDV,SAAmBK,EAAMC,cACnCC,KACAC,EAAiB,QAAQC,KAAKC,SAASC,WAAWC,UAAU,QAC9C,mBAAPP,IAAmBA,EAAO,IAAIQ,SAASC,UAAUH,SAASI,KAAKV,QAAUG,OACpFH,EAyDD,SAAeA,EAAMG,EAAgBD,GASpC,OAJAF,GAJAA,EAAOA,EAAKW,QAAQ,sCAA+BC,EAAGC,GAErD,OADAX,EAAQY,SAAU,KACRD,EAASV,iBAERQ,QAAQ,2GAAoGC,EAAGC,EAAQ5B,EAAM8B,EAAIC,GAE5I,OADAd,EAAQc,IAAQ,KACNH,EAASV,MAAkBa,MAAQ/B,EAAO8B,EAAKC,WAE5Cb,WAAuBH,OAASG,MAlEvCc,CAAMjB,EAAMG,EAAgBD,GAAW,MAAMM,SAASC,UAAUH,SAASI,KAAKjC,aAAgB0B,SACrGhB,IAKC+B,EALGC,EAAMC,IAAIC,gBAAgB,IAAIC,MAAMtB,KACvCuB,EAAS,IAAIC,OAAOL,EAAKlB,GACzBwB,EAAOF,EAAOG,UACd9C,KACA+C,EAAU,EAsBX,IAAKT,KApBLK,EAAOK,cAAOC,GACbN,EAAOnC,aAAcH,KAAM,cAAQ4C,IACnCC,WAAWP,EAAOG,YAEnBH,EAAOG,qBACNN,IAAIW,gBAAgBZ,GACpBM,EAAKf,KAAKsB,IAEXT,EAAOb,cAAQxB,EAAQQ,UAAW,IAAIJ,iBAAUC,EAAS0C,GACxD9C,IAAIH,EAAK,SAAQ2C,EACjB/C,EAAUI,IAAOO,EAAS0C,GAC1BV,EAAOnC,aAAcH,KAAM,SAAOD,SAAIE,SAAQQ,OAE/C6B,EAAO5C,cACPF,EAAM8C,EAAQA,EAAO5C,WAAYC,GACjC2C,EAAOW,gBAASC,GACfZ,EAAOL,GAAK,WACX,OAAOK,EAAOb,KAAKyB,KAAeC,MAAM1B,KAAK2B,cAGrCnC,EAAegB,KAAKK,GAASA,EAAOW,OAAOhB,GACrD,OAAOK"}