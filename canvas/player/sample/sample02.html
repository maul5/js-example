<html>
<head>
<title>Canvas-based Video Player</title>
</head>

<body>
<h3>Canvas-based Video Player</h3>
<p></p>
<video id="video" style="display:none"></video>
<div>
Canvas A: Scaled Copy</br>
<canvas id="canvas">Canvas A</canvas>
</div>
<p></p>
<div>
Canvas B: by Time Update</br>
<canvas id="canvas2">Canvas B</canvas>
</div>
<p></p>
<div>
<button id="play" onclick="playVideo()">Play</button>
<button id="pause" onclick="pauseVideo()">Pause</button>
<button id="stop" onclick="stopVideo()">Stop</button>
Video: <input id="input" type="text" name="fname" value="big_buck_bunny.mp4"  style="color:blue" />
</div>
</body>

<script>
window.onload = function() {
   initDocument();
   initVideo(input.value);
}

var video = document.getElementById('video');
var canvas = document.getElementById('canvas');
var context = canvas.getContext('2d');

var canvas2= document.getElementById('canvas2');
var context2 = canvas2.getContext('2d', {desynchronized: true});

var input = document.getElementById('input');

function initDocument() {
   console.log("initDocument: ");

   video.addEventListener('canplay', function() {
      console.log("canplay");
      copyVideoToCanvas(video, context);
      copyCanvasToCanvas(canvas, context2);
   }, true);

   video.addEventListener('timeupdate', function() {
      copyCanvasToCanvas(canvas, context2);
   }, true);

   video.addEventListener('play', function () {
      var $this = this;
      (function loop() {
         if (!$this.paused && !$this.ended) {
            renderVideoToCanvas(video, context);
            setTimeout(loop, 1000 / 30);
         }
      })();
   }, true);

   input.addEventListener('change', (event) => {
      // const fpath = event.target.value;
      // fname = fpath.split(/(\\|\/)/g).pop();
      // console.log("change", fname);
      initVideo(input.value);
   }, true); 
}

// Render video image on canvas with resizing
function renderVideoToCanvas(srcVideo, dstContext) {
   // fill vertically  
   var vratio = (dstContext.canvas.height / srcVideo.videoHeight) * srcVideo.videoWidth;
   dstContext.drawImage(srcVideo, 0,0, vratio, dstContext.canvas.height);
   // fill horizontally  
   var hratio = (dstContext.canvas.width / srcVideo.videoWidth) * srcVideo.videoHeight;
   dstContext.drawImage(srcVideo, 0,0, dstContext.canvas.width, hratio); 
}

// Copy video image to another canvas without resizing
function copyVideoToCanvas(srcVideo, dstContext) {
   dstContext.canvas.width = srcVideo.videoWidth;
   dstContext.canvas.height = srcVideo.videoHeight;
   dstContext.drawImage(srcVideo, 0,0, srcVideo.videoWidth, srcVideo.videoHeight); 
}

// Copy canvas image to another canvas without resizing
function copyCanvasToCanvas(srcCanvas, dstContext) {
   dstContext.canvas.width = srcCanvas.width;
   dstContext.canvas.height = srcCanvas.height;
   dstContext.drawImage(srcCanvas, 0, 0);
}

function resizeCanvas(canvas, width, height) {
   console.log("resizeCanvas 1: ", video.videoWidth, video.videoHeight);
   canvas.width = width;
   canvas.height = height;
   console.log("resizeCanvas 2: ", canvas.width, canvas.height);
}

function initVideo(fname) {
   console.log("initVideo: ", fname);
   video.src = fname;
   video.load();
   video.currentTime = 0.001;
}

function playVideo() {
   console.log("playVideo: ");
   video.play();
}

function pauseVideo() {
   console.log("pauseVideo: ");
   video.pause();
}

function stopVideo() {
   console.log("stopVideo: ");
   video.pause();
   video.currentTime = 0.001;
}

</script>
</html>