<!DOCTYPE html> 
<title>Video/Canvas Demo 8: Worker</title> 
<script> 
document.addEventListener('DOMContentLoaded', function(){
	var v = document.getElementById('v');
	//var canvas = document.getElementById('c');
	//var context = canvas.getContext('2d', {desynchronized: true}); // not work
	const canvas = document.getElementById('c').transferControlToOffscreen();
	//var context = canvas.getContext('2d'); // don't use in offscreen
	
	var back = document.createElement('canvas');
	var backcontext = back.getContext('2d', {desynchronized: true});
 
	const workerCode = document.querySelector('#workerCode').textContent;
	const blob = new Blob([workerCode], { type: 'text/javascript' });
	const url = URL.createObjectURL(blob);
	
	const worker = new Worker(url);
	worker.onmessage = function(e) {
		console.log('main:' + e.data.msg);
	}
	worker.postMessage({msg: 'start', canvas: canvas}, [canvas]);

	var cw,ch;
	v.addEventListener('play', function(){
		cw = v.clientWidth;
		ch = v.clientHeight;
		canvas.width = cw;
		canvas.height = ch;
		back.width = cw;
		back.height = ch;
		draw(v,worker,cw,ch);
		
	},false);
},false);
 
function draw(v,k,w,h) {
	if(v.paused || v.ended)	return false;
	
	//onst pixels = v.getImageData(0,0,w,h);
	k.postMessage({msg: 'play'});
	setTimeout(draw,100,v,k,w,h);	// default: 20ms
}
</script> 

<script type="script/worker" id="workerCode"> 	// inline worker
    var ctx;
	self.onmessage = async function(e) {
		//console.log('worker: ' + e.data.msg);
      	switch (e.data.msg) {
			case 'start':
				if (!ctx) {
					ctx = e.data.canvas.getContext('2d');
				}
				ctx.fillRect(0,0,100,100);
				postMessage({msg: e.data.msg});
				break;
			case 'play':
				ctx.clearRect(0,0,100,100);
				ctx.flllStyle = "#FF0000";
				ctx.fillRect(100,100,500,500);
				postMessage({msg: e.data.msg});
				break;
			case 'stop':
				postMessage({msg: e.data.msg});
				break;
      	}
	}
</script>

<style> 
#c {
	position: absolute;
	top: 50%;
	left: 50%;
	margin: -180px 0 0 20px;
}
 
#v {
	position: absolute;
	top: 50%;
	left: 50%;
	margin: -180px 0 0 -500px;
}
</style> 

</body>
<center>
<h2>Video/Canvas Demo 8: Worker</h2>
</center>
<video id="v" controls loop> 
	<source src=video.webm type=video/webm> 
	<source src=video.ogg type=video/ogg> 
	<source src=video.mp4 type=video/mp4> 
</video> 
<canvas id="c"></canvas> 
</body> 
</html>